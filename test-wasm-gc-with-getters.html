<!DOCTYPE html>
<html>
<head><title>WASM GC Struct Test with Manual Getters</title></head>
<body>
  <h1>Testing WASM GC Struct with Manual Getter/Setter</h1>
  <div id="log"></div>

  <script type="text/wast">
(module
  ;; Simple struct with one i32 field
  (type $box (struct (field $val (mut i32))))

  ;; Create a box with a value
  (func $makeBox (export "makeBox") (param $v i32) (result (ref $box))
    local.get $v
    struct.new $box
  )

  ;; Manually exported getter for field 0
  (func $get_val (export "get_val") (param $boxRef (ref $box)) (result i32)
    local.get $boxRef
    struct.get $box $val
  )

  ;; Manually exported setter for field 0
  (func $set_val (export "set_val") (param $boxRef (ref $box)) (param $newVal i32)
    local.get $boxRef
    local.get $newVal
    struct.set $box $val
  )
)
  </script>

  <script>
    function log(msg, level = 'log') {
      const div = document.getElementById('log');
      const p = document.createElement('p');
      p.textContent = msg;
      p.style.color = level === 'error' ? 'red' : level === 'info' ? 'blue' : 'black';
      div.appendChild(p);
      console[level](msg);
    }

    setTimeout(() => {
      log('=== WASM GC Struct Access Test (With Manual Getters) ===', 'info');

      // Check if functions are available
      if (typeof window.makeBox !== 'function') {
        log('‚ùå makeBox() function not found', 'error');
        return;
      }
      if (typeof window.get_val !== 'function') {
        log('‚ùå get_val() function not found', 'error');
        return;
      }
      if (typeof window.set_val !== 'function') {
        log('‚ùå set_val() function not found', 'error');
        return;
      }

      log('‚úÖ All functions available: makeBox, get_val, set_val');

      try {
        // Create a box with value 42
        log('Creating box with value 42...');
        const box = window.makeBox(42);
        log('‚úÖ Box created (GC struct reference)');

        // Test getter function
        log('Testing getter function...', 'info');
        const val = window.get_val(box);
        log('get_val(box) = ' + val, 'info');

        if (val === 42) {
          log('‚úÖ SUCCESS: Got correct value from GC struct! get_val(box) = 42', 'info');
        } else {
          log('‚ùå ERROR: Expected 42, got ' + val, 'error');
        }

        // Test setter function
        log('Testing setter function...', 'info');
        window.set_val(box, 99);
        log('Called set_val(box, 99)', 'info');

        const newVal = window.get_val(box);
        if (newVal === 99) {
          log('‚úÖ SUCCESS: Setter works! get_val(box) = ' + newVal, 'info');
        } else {
          log('‚ùå ERROR: Expected 99, got ' + newVal, 'error');
        }

        // Test that the same box instance is being modified
        log('Testing instance identity...');
        window.set_val(box, 123);
        const finalVal = window.get_val(box);
        log('After set_val(box, 123), get_val(box) = ' + String(finalVal));
        if (finalVal === 123) {
          log('‚úÖ SUCCESS: GC struct field mutation works correctly!', 'info');
          log('üéâ All WASM GC struct tests passed!', 'info');
        } else {
          log('‚ùå ERROR: Expected 123, got ' + String(finalVal), 'error');
        }

      } catch (e) {
        log('‚ùå Error: ' + String(e.message), 'error');
        console.error(e);
      }
    }, 1000);
  </script>
</body>
</html>
