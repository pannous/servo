<!DOCTYPE html>
<html>
<head><title>Immutable Global, Mutable Field Test</title></head>
<body>
  <h1>Immutable Global, Mutable Field Test</h1>
  <div id="log"></div>

  <script type="text/wast">
(module
  ;; Struct with MUTABLE field
  (type $Box (struct (field $val (mut i32))))

  ;; IMMUTABLE global (no 'mut' keyword) pointing to a struct
  ;; The global reference cannot be changed, but the struct's fields CAN be!
  (global $immutableGlobal (export "immutableGlobal") (ref $Box)
    (struct.new $Box (i32.const 42)))

  ;; For comparison: truly immutable struct (immutable field)
  (type $FrozenBox (struct (field $val i32)))
  (global $frozenGlobal (export "frozenGlobal") (ref $FrozenBox)
    (struct.new $FrozenBox (i32.const 100)))

  ;; Helper function to read the values
  (func $getImmutableVal (export "getImmutableVal") (result i32)
    global.get $immutableGlobal
    struct.get $Box 0
  )

  (func $getFrozenVal (export "getFrozenVal") (result i32)
    global.get $frozenGlobal
    struct.get $FrozenBox 0
  )
)
  </script>

  <script>
    function log(msg, color = 'black') {
      const div = document.getElementById('log');
      const p = document.createElement('p');
      p.textContent = msg;
      p.style.color = color;
      div.appendChild(p);
      console.log(msg);
    }

    setTimeout(() => {
      log('=== Testing Immutable Global with Mutable Field ===', 'blue');
      log('', 'black');

      // Test 1: Immutable global, mutable field
      log('üì¶ immutableGlobal:', 'blue');
      log('Initial value: ' + window.immutableGlobal.val, 'black');
      log('getImmutableVal() = ' + window.getImmutableVal(), 'black');

      // Try to modify the field
      log('', 'black');
      log('üîß Attempting: immutableGlobal.val = 999', 'orange');
      window.immutableGlobal.val = 999;
      log('After modification: ' + window.immutableGlobal.val, 'black');
      log('getImmutableVal() = ' + window.getImmutableVal(), 'black');

      if (window.getImmutableVal() === 999) {
        log('‚úÖ SUCCESS: Field was modified (mutable field in immutable global!)', 'green');
      } else {
        log('‚ùå Field modification failed', 'red');
      }

      // Test 2: Try to reassign the global (should fail)
      log('', 'black');
      log('üîß Attempting: immutableGlobal = makeBox(777)', 'orange');
      try {
        const newBox = window.makeBox ? window.makeBox(777) : {val: 777};
        const oldBox = window.immutableGlobal;
        window.immutableGlobal = newBox;

        if (window.getImmutableVal() === 777) {
          log('‚ö†Ô∏è  WARNING: Global was reassigned (should be immutable!)', 'orange');
        } else {
          log('‚úÖ Global reference unchanged (WASM global is immutable)', 'green');
          log('   JS allowed assignment, but WASM still points to original', 'blue');
        }
      } catch (e) {
        log('‚úÖ Global reassignment blocked: ' + e.message, 'green');
      }

      // Test 3: Truly immutable (immutable field)
      log('', 'black');
      log('üì¶ frozenGlobal (immutable field):', 'blue');
      log('Initial value: ' + window.frozenGlobal.val, 'black');
      log('getFrozenVal() = ' + window.getFrozenVal(), 'black');

      log('', 'black');
      log('üîß Attempting: frozenGlobal.val = 888', 'orange');
      try {
        window.frozenGlobal.val = 888;
        log('After attempt: ' + window.frozenGlobal.val, 'black');
        log('getFrozenVal() = ' + window.getFrozenVal(), 'black');

        if (window.getFrozenVal() === 888) {
          log('‚ö†Ô∏è  Immutable field was modified!', 'orange');
        } else {
          log('‚úÖ Immutable field rejected modification', 'green');
        }
      } catch (e) {
        log('‚úÖ Modification blocked: ' + e.message, 'green');
      }

      // Summary
      log('', 'black');
      log('‚ïê‚ïê‚ïê Summary ‚ïê‚ïê‚ïê', 'blue');
      log('‚Ä¢ Immutable global + mutable field = You can change the field!', 'black');
      log('‚Ä¢ Immutable global reference = Cannot reassign to different struct', 'black');
      log('‚Ä¢ Immutable field = Cannot change the field value', 'black');

    }, 500);
  </script>
</body>
</html>
